name: Backend Runner

on:
  workflow_dispatch:
    inputs:
      duration:
        description: 'Run duration (e.g. 1h, 2h)'
        default: '2h'
        required: false

jobs:
  run-backend:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'
          cache: 'pip'

      - name: Install Dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install pytest

      - name: Run Tests
        run: python -m pytest tests/ -v --tb=short

      - name: Setup Ngrok Tunnel
        env:
          NGROK_AUTH_TOKEN: ${{ secrets.NGROK_AUTH_TOKEN }}
          NGROK_DOMAIN: ${{ secrets.NGROK_DOMAIN }}
        run: |
          chmod +x scripts/setup_tunnel.sh
          ./scripts/setup_tunnel.sh
          sleep 3

      - name: Start Backend
        env:
          INFISICAL_CLIENT_ID: ${{ secrets.INFISICAL_CLIENT_ID }}
          INFISICAL_CLIENT_SECRET: ${{ secrets.INFISICAL_CLIENT_SECRET }}
          INFISICAL_PROJECT_ID: ${{ secrets.INFISICAL_PROJECT_ID }}
        run: |
          DURATION="${{ github.event.inputs.duration }}"
          echo "üöÄ Starting backend for $DURATION..."
          echo "üåê Backend accessible at: https://${{ secrets.NGROK_DOMAIN }}"
          timeout $DURATION python -m uvicorn backend.main:app --host 0.0.0.0 --port 8000 || echo "‚èπÔ∏è Backend stopped after $DURATION."
